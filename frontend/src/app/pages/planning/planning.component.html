<app-navbar></app-navbar>

<div class="container">
  <div class="page-header">
    <h1>Planning</h1>
    <p class="subtitle">Planifie tes entra√Ænements avec l'IA</p>
  </div>

  @if (successMessage()) {
    <div class="success-box">{{ successMessage() }}</div>
  }

  @if (error()) {
    <div class="error-box">{{ error() }}</div>
  }

  <div class="main-layout">
    <!-- Zone principale : Calendrier -->
    <div class="main-content">
      <!-- Navigation du calendrier -->
      <div class="calendar-nav">
        <button class="nav-btn" (click)="previousMonth()">‚Üê</button>
        <span class="current-month">{{ getMonthName() }}</span>
        <button class="nav-btn" (click)="nextMonth()">‚Üí</button>
      </div>

      <!-- Calendrier -->
      <div class="calendar">
        <!-- En-t√™tes des jours -->
        <div class="calendar-header">
          @for (day of weekDays; track day) {
            <div class="calendar-header-cell">{{ day }}</div>
          }
        </div>

        <!-- Grille du calendrier -->
        @if (isLoading()) {
          <div class="loading">Chargement...</div>
        } @else {
          <div class="calendar-grid">
            @for (day of calendarDays(); track day.date.getTime()) {
              <div
                class="calendar-day"
                [class.other-month]="!day.isCurrentMonth"
                [class.today]="day.isToday"
                [class.has-events]="day.runs.length > 0 || day.plannedRuns.length > 0"
                (click)="selectDay(day)">
                <span class="day-number">{{ day.dayOfMonth }}</span>

                @if (day.runs.length > 0 || day.plannedRuns.length > 0) {
                  <div class="day-indicators">
                    @for (indicator of getDayIndicators(day); track indicator.type) {
                      <div class="indicator-badge" [class]="indicator.type">
                        {{ indicator.count }}
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>

      <!-- L√©gende -->
      <div class="legend">
        <div class="legend-item">
          <span class="legend-dot completed"></span>
          <span>Course effectu√©e</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot planned"></span>
          <span>S√©ance planifi√©e</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot done"></span>
          <span>Planifi√©e (compl√©t√©e)</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot skipped"></span>
          <span>Planifi√©e (pass√©e)</span>
        </div>
      </div>
    </div>

    <!-- Sidebar : G√©n√©ration IA et actions -->
    <div class="sidebar">
      <!-- Carte G√©n√©ration IA -->
      <div class="sidebar-card generate-card">
        <h3>G√©n√©ration IA</h3>
        <p class="card-description">Laisse l'IA cr√©er ton programme d'entra√Ænement personnalis√© pour la semaine.</p>
        <button
          class="btn-generate"
          (click)="openGenerateOptions()"
          [disabled]="isGenerating()">
          @if (isGenerating()) {
            G√©n√©ration...
          } @else {
            G√©n√©rer une semaine
          }
        </button>
      </div>

      <!-- Carte R√©sum√© du mois -->
      <div class="sidebar-card week-summary">
        <h3>Ce mois</h3>
        <div class="summary-stats">
          <div class="stat-item">
            <span class="stat-value">{{ getMonthStats().planned }}</span>
            <span class="stat-label">Planifi√©es</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ getMonthStats().completed }}</span>
            <span class="stat-label">Compl√©t√©es</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ getMonthStats().totalKm }}</span>
            <span class="stat-label">km</span>
          </div>
        </div>
      </div>

      <!-- Carte Actions rapides -->
      <div class="sidebar-card quick-actions">
        <h3>Actions rapides</h3>
        <div class="quick-actions-list">
          <button class="quick-action-btn" (click)="goToToday()">
            <span class="action-icon">üìÖ</span>
            Aujourd'hui
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal d√©tail du jour -->
@if (selectedDay()) {
  <div class="modal-backdrop" (click)="closeDetail()"></div>
  <div class="modal">
    <div class="modal-header">
      <h2>{{ formatDate(selectedDay()!.date) }}</h2>
      <div class="modal-header-actions">
        @if (!isAddingSession()) {
          <button class="btn-add" (click)="openAddSession()" title="Ajouter une s√©ance">+</button>
        }
        <button class="modal-close" (click)="closeDetail()">√ó</button>
      </div>
    </div>

    <div class="modal-body">
      <!-- Formulaire d'ajout de s√©ance -->
      @if (isAddingSession()) {
        <div class="add-session-form">
          <h3>Nouvelle s√©ance</h3>

          <div class="form-group">
            <label>Type de s√©ance</label>
            <select [(ngModel)]="newSession.sessionType">
              @for (type of sessionTypes; track type.value) {
                <option [value]="type.value">{{ type.label }}</option>
              }
            </select>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Distance (km)</label>
              <input type="number" [(ngModel)]="newSession.targetDistance" placeholder="Ex: 10">
            </div>
            <div class="form-group">
              <label>Dur√©e (min)</label>
              <input type="number" [(ngModel)]="newSession.targetDuration" placeholder="Ex: 45">
            </div>
          </div>

          <div class="form-group">
            <label>Allure cible</label>
            <input type="text" [(ngModel)]="newSession.targetPace" placeholder="Ex: 5:30">
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea [(ngModel)]="newSession.description" placeholder="Notes ou d√©tails..."></textarea>
          </div>

          <div class="form-actions">
            <button class="btn-cancel" (click)="cancelAddSession()">Annuler</button>
            <button class="btn-save" (click)="saveSession()" [disabled]="isSaving()">
              @if (isSaving()) { Enregistrement... } @else { Enregistrer }
            </button>
          </div>
        </div>
      }

      @if (!isAddingSession() && selectedDay()!.runs.length === 0 && selectedDay()!.plannedRuns.length === 0) {
        <div class="empty-day">
          <p>Aucune activit√© ce jour</p>
          <button class="btn-add-empty" (click)="openAddSession()">+ Ajouter une s√©ance</button>
        </div>
      }

      <!-- Courses effectu√©es -->
      @if (!isAddingSession() && selectedDay()!.runs.length > 0) {
        <div class="section">
          <h3>Courses effectu√©es</h3>
          @for (run of selectedDay()!.runs; track run._id) {
            <div class="event-card completed clickable" (click)="openRunDetail(run)">
              <button class="delete-btn" (click)="deleteRun(run); $event.stopPropagation()" title="Supprimer">√ó</button>
              @if (run.stravaActivityId) {
                <span class="strava-badge">Strava</span>
              }
              <div class="event-header">
                <span class="event-type">{{ run.sessionType || 'Course' }}</span>
                <span class="view-detail">Voir &rarr;</span>
              </div>
              @if (run.notes) {
                <div class="run-notes">
                  <span class="run-title">{{ getRunTitle(run.notes) }}</span>
                  @if (getRunDescription(run.notes)) {
                    <p class="run-description">{{ getRunDescription(run.notes) }}</p>
                  }
                </div>
              }
              <div class="event-stats">
                @if (run.distance) {
                  <span>{{ run.distance }} km</span>
                }
                @if (run.duration) {
                  <span>{{ run.duration }} min</span>
                }
                @if (run.averagePace) {
                  <span>{{ run.averagePace }}/km</span>
                }
              </div>
            </div>
          }
        </div>
      }

      <!-- S√©ances planifi√©es -->
      @if (!isAddingSession() && selectedDay()!.plannedRuns.length > 0) {
        <div class="section">
          <h3>S√©ances planifi√©es</h3>
          @for (planned of selectedDay()!.plannedRuns; track planned._id) {
            <div class="event-card" [class.done]="planned.status === 'completed'" [class.skipped]="planned.status === 'skipped'" [class.ai-generated]="planned.generatedBy === 'ai'">
              <button class="delete-btn" (click)="deletePlannedRun(planned)" title="Supprimer">√ó</button>
              <span class="event-status" [class]="planned.status">
                @if (planned.status === 'planned') { √Ä faire }
                @if (planned.status === 'completed') { Fait }
                @if (planned.status === 'skipped') { Pass√© }
              </span>
              @if (planned.generatedBy === 'ai') {
                <span class="coach-badge">S√©ance du coach</span>
              }
              <div class="event-header">
                <span class="event-type">{{ getSessionTypeLabel(planned.sessionType) }}</span>
              </div>

              <div class="event-stats">
                @if (planned.targetDistance) {
                  <span>{{ planned.targetDistance }} km</span>
                }
                @if (planned.targetDuration) {
                  <span>{{ planned.targetDuration }} min</span>
                }
                @if (planned.targetPace) {
                  <span>{{ planned.targetPace }}/km</span>
                }
              </div>

              @if (planned.description) {
                <p class="event-description">{{ planned.description }}</p>
              }

              @if (planned.mainWorkout) {
                <div class="workout-detail">
                  <strong>S√©ance :</strong> {{ planned.mainWorkout }}
                </div>
              }

              @if (planned.status === 'planned') {
                <div class="event-actions">
                  <button class="btn-done" (click)="markAsCompleted(planned)">Marquer fait</button>
                  <button class="btn-skip" (click)="markAsSkipped(planned)">Passer</button>
                </div>
              }
            </div>
          }
        </div>
      }
    </div>
  </div>
}

<!-- Modal options de g√©n√©ration -->
@if (showGenerateOptions()) {
  <div class="modal-backdrop" (click)="closeGenerateOptions()"></div>
  <div class="modal generate-modal">
    <div class="modal-header">
      <h2>G√©n√©rer un plan</h2>
      <button class="modal-close" (click)="closeGenerateOptions()">√ó</button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label>Semaine du</label>
        <input type="date" [(ngModel)]="generateStartDate">
        <p class="form-hint">Les s√©ances seront g√©n√©r√©es sur tes jours d'entra√Ænement √† partir de cette date</p>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeGenerateOptions()">Annuler</button>
      <button class="btn-confirm" (click)="generatePlan(1)">
        G√©n√©rer
      </button>
    </div>
  </div>
}

<!-- Modal preview des s√©ances g√©n√©r√©es -->
@if (showPreview()) {
  <div class="modal-backdrop" (click)="cancelPreview()"></div>
  <div class="modal preview-modal">
    <div class="modal-header">
      <h2>S√©ances g√©n√©r√©es</h2>
      <button class="modal-close" (click)="cancelPreview()">√ó</button>
    </div>

    <div class="modal-body">
      <p class="preview-intro">
        <span class="coach-badge">S√©ances du coach</span>
        L'IA a g√©n√©r√© {{ previewSessions().length }} s√©ance(s) pour toi. Confirme pour les ajouter √† ton planning.
      </p>

      <div class="preview-list">
        @for (session of previewSessions(); track session.date) {
          <div class="preview-card">
            <div class="preview-date">{{ formatPreviewDate(session.date!) }}</div>
            <div class="preview-content">
              <span class="preview-type">{{ getSessionTypeLabel(session.sessionType!) }}</span>
              <div class="preview-stats">
                @if (session.targetDistance) {
                  <span>{{ session.targetDistance }} km</span>
                }
                @if (session.targetDuration) {
                  <span>{{ session.targetDuration }} min</span>
                }
                @if (session.targetPace) {
                  <span>{{ session.targetPace }}/km</span>
                }
              </div>
              @if (session.description) {
                <p class="preview-description">{{ session.description }}</p>
              }
              @if (session.mainWorkout) {
                <p class="preview-workout">{{ session.mainWorkout }}</p>
              }
            </div>
          </div>
        }
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" (click)="cancelPreview()">Annuler</button>
      <button class="btn-confirm" (click)="confirmPlan()" [disabled]="isConfirming()">
        @if (isConfirming()) { Confirmation... } @else { Confirmer }
      </button>
    </div>
  </div>
}
