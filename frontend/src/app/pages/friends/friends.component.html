<app-navbar></app-navbar>

<div class="container">
  <div class="page-header">
    <h1>Amis</h1>
    <p class="subtitle">Gère tes amis et tes demandes</p>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button
      class="tab"
      [class.active]="activeTab() === 'friends'"
      (click)="setTab('friends')">
      Mes amis
      @if (friendService.friends().length > 0) {
        <span class="tab-badge">{{ friendService.friends().length }}</span>
      }
    </button>
    <button
      class="tab"
      [class.active]="activeTab() === 'requests'"
      (click)="setTab('requests')">
      Demandes
      @if (friendService.pendingCount() > 0) {
        <span class="tab-badge pending">{{ friendService.pendingCount() }}</span>
      }
    </button>
    <button
      class="tab"
      [class.active]="activeTab() === 'search'"
      (click)="setTab('search')">
      Rechercher
    </button>
  </div>

  <!-- Content -->
  <div class="content">
    <!-- Friends List -->
    @if (activeTab() === 'friends') {
      @if (isLoading()) {
        <div class="loading-state">
          <div class="loading-spinner"></div>
          <p>Chargement...</p>
        </div>
      } @else if (friendService.friends().length === 0) {
        <div class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <line x1="19" y1="8" x2="19" y2="14"/>
            <line x1="22" y1="11" x2="16" y2="11"/>
          </svg>
          <p>Tu n'as pas encore d'amis</p>
          <button class="btn-primary" (click)="setTab('search')">Rechercher des amis</button>
        </div>
      } @else {
        <div class="users-list">
          @for (friend of friendService.friends(); track friend._id) {
            <div class="user-card">
              <div class="user-avatar clickable" [class.online]="friend.isOnline" (click)="openProfile(friend._id)">
                @if (friend.profilePicture) {
                  <img [src]="friend.profilePicture" alt="Avatar">
                } @else {
                  {{ getInitials(friend.firstName, friend.lastName) }}
                }
              </div>
              <div class="user-info clickable" (click)="openProfile(friend._id)">
                <span class="user-name">{{ friend.firstName }} {{ friend.lastName }}</span>
                <span class="user-status">{{ friend.isOnline ? 'En ligne' : 'Hors ligne' }}</span>
              </div>
              <div class="user-actions">
                <button class="btn-icon" title="Envoyer un message" (click)="openConversation(friend._id)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                  </svg>
                </button>
                <button class="btn-icon" title="Voir le profil" (click)="openProfile(friend._id)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                  </svg>
                </button>
                <button class="btn-icon danger" title="Supprimer" (click)="removeFriend(friend._id)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <line x1="17" y1="11" x2="22" y2="11"/>
                  </svg>
                </button>
              </div>
            </div>
          }
        </div>
      }
    }

    <!-- Requests -->
    @if (activeTab() === 'requests') {
      <div class="requests-section">
        <h3>Demandes reçues</h3>
        @if (friendService.pendingRequests().length === 0) {
          <p class="empty-text">Aucune demande en attente</p>
        } @else {
          <div class="users-list">
            @for (request of friendService.pendingRequests(); track request._id) {
              <div class="user-card">
                <div class="user-avatar">
                  @if (request.requester.profilePicture) {
                    <img [src]="request.requester.profilePicture" alt="Avatar">
                  } @else {
                    {{ getInitials(request.requester.firstName, request.requester.lastName) }}
                  }
                </div>
                <div class="user-info">
                  <span class="user-name">{{ request.requester.firstName }} {{ request.requester.lastName }}</span>
                  <span class="user-status">Souhaite être votre ami</span>
                </div>
                <div class="user-actions">
                  <button class="btn-accept" (click)="acceptRequest(request._id)">Accepter</button>
                  <button class="btn-reject" (click)="rejectRequest(request._id)">Refuser</button>
                </div>
              </div>
            }
          </div>
        }
      </div>

      <div class="requests-section">
        <h3>Demandes envoyées</h3>
        @if (friendService.sentRequests().length === 0) {
          <p class="empty-text">Aucune demande envoyée</p>
        } @else {
          <div class="users-list">
            @for (request of friendService.sentRequests(); track request._id) {
              <div class="user-card">
                <div class="user-avatar">
                  @if (request.recipient.profilePicture) {
                    <img [src]="request.recipient.profilePicture" alt="Avatar">
                  } @else {
                    {{ getInitials(request.recipient.firstName, request.recipient.lastName) }}
                  }
                </div>
                <div class="user-info">
                  <span class="user-name">{{ request.recipient.firstName }} {{ request.recipient.lastName }}</span>
                  <span class="user-status">En attente de réponse</span>
                </div>
                <div class="user-actions">
                  <button class="btn-cancel" (click)="cancelRequest(request.recipient._id)">Annuler</button>
                </div>
              </div>
            }
          </div>
        }
      </div>
    }

    <!-- Search -->
    @if (activeTab() === 'search') {
      <div class="search-section">
        <div class="search-input-wrapper">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"/>
            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
          </svg>
          <input
            type="text"
            [(ngModel)]="searchQuery"
            (ngModelChange)="onSearchInput()"
            placeholder="Rechercher par nom ou email..."
            autocomplete="off">
        </div>

        @if (isSearching()) {
          <div class="loading-state small">
            <div class="loading-spinner"></div>
          </div>
        } @else if (searchQuery.length >= 2 && searchResults().length === 0) {
          <p class="empty-text">Aucun utilisateur trouvé</p>
        } @else if (searchResults().length > 0) {
          <div class="users-list">
            @for (user of searchResults(); track user._id) {
              <div class="user-card">
                <div class="user-avatar" [class.online]="user.isOnline">
                  @if (user.profilePicture) {
                    <img [src]="user.profilePicture" alt="Avatar">
                  } @else {
                    {{ getInitials(user.firstName, user.lastName) }}
                  }
                </div>
                <div class="user-info">
                  <span class="user-name">{{ user.firstName }} {{ user.lastName }}</span>
                  @if (user.friendship) {
                    <span class="user-status">{{ getStatusText(user.friendship) }}</span>
                  }
                </div>
                <div class="user-actions">
                  @if (!user.friendship) {
                    <button class="btn-add" (click)="sendRequest(user._id)">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <line x1="19" y1="8" x2="19" y2="14"/>
                        <line x1="22" y1="11" x2="16" y2="11"/>
                      </svg>
                      Ajouter
                    </button>
                  } @else if (user.friendship.status === 'pending' && user.friendship.isRequester) {
                    <button class="btn-cancel" (click)="cancelRequest(user._id)">Annuler</button>
                  } @else if (user.friendship.status === 'pending' && !user.friendship.isRequester) {
                    <button class="btn-accept" (click)="acceptRequest(user.friendship.friendshipId)">Accepter</button>
                  } @else if (user.friendship.status === 'accepted') {
                    <span class="friend-badge">Ami</span>
                  }
                </div>
              </div>
            }
          </div>
        } @else {
          <p class="hint-text">Tape au moins 2 caractères pour rechercher</p>
        }
      </div>
    }
  </div>
</div>
