<app-navbar></app-navbar>

<div class="container">
  <div class="page-header">
    <h1>Mon Profil</h1>
    <p class="subtitle">Historique de tes courses</p>
  </div>

  <main>
    <!-- Infos utilisateur -->
    <section class="user-card">
      <div class="user-avatar">
        @if (authService.currentUser()?.profilePicture) {
          <img [src]="authService.currentUser()?.profilePicture" alt="Photo de profil">
        } @else {
          {{ authService.currentUser()?.firstName?.charAt(0) }}{{ authService.currentUser()?.lastName?.charAt(0) }}
        }
      </div>
      <div class="user-info">
        <h2>{{ authService.currentUser()?.firstName }} {{ authService.currentUser()?.lastName }}</h2>
        <p class="user-email">{{ authService.currentUser()?.email }}</p>
      </div>
      <a routerLink="/settings" class="btn-settings">Paramètres</a>
    </section>

    <!-- Profil coureur -->
    <section class="runner-profile">
      <div class="section-header">
        <h3>Profil coureur</h3>
        <button class="btn-edit" (click)="toggleEdit()">
          @if (isEditing()) {
            Annuler
          } @else {
            Modifier
          }
        </button>
      </div>

      @if (saveSuccess()) {
        <div class="success-box">Profil mis à jour avec succès !</div>
      }

      @if (saveError()) {
        <div class="error-box">{{ saveError() }}</div>
      }

      @if (!isEditing()) {
        <!-- Mode lecture -->
        <div class="profile-grid">
        <div class="profile-item">
          <span class="profile-label">Age</span>
          <span class="profile-value">{{ authService.currentUser()?.age || 'Non défini' }}</span>
        </div>
        <div class="profile-item">
          <span class="profile-label">Genre</span>
          <span class="profile-value">{{ authService.currentUser()?.gender || 'Non défini'}}</span>
        </div>
          <div class="profile-item">
            <span class="profile-label">Niveau</span>
            <span class="profile-value">{{ getLevelLabel(authService.currentUser()?.runningLevel) }}</span>
          </div>
          <div class="profile-item">
            <span class="profile-label">Objectif</span>
            <span class="profile-value">{{ getGoalLabel(authService.currentUser()?.goal) }}</span>
          </div>
          <div class="profile-item">
            <span class="profile-label">Fréquence</span>
            <span class="profile-value">
              @if (authService.currentUser()?.weeklyFrequency) {
                {{ authService.currentUser()?.weeklyFrequency }} séances/semaine
              } @else {
                Non défini
              }
            </span>
          </div>
          <div class="profile-item">
            <span class="profile-label">Détails objectif</span>
            <span class="profile-value">{{ authService.currentUser()?.goalDetails || 'Non défini' }}</span>
          </div>
          <div class="profile-item full-width">
            <span class="profile-label">Blessures / Points de vigilance</span>
            <span class="profile-value">{{ authService.currentUser()?.injuries || 'Aucun' }}</span>
          </div>
          <div class="profile-item">
            <span class="profile-label">Jours disponibles</span>
            <span class="profile-value">{{ getAvailableDaysDisplay() }}</span>
          </div>
          <div class="profile-item">
            <span class="profile-label">Créneau préféré</span>
            <span class="profile-value">{{ getPreferredTimeLabel(authService.currentUser()?.preferredTime) }}</span>
          </div>
        </div>
      } @else {
        <!-- Mode édition -->
        <form class="profile-form" (ngSubmit)="saveProfile()">
          <div class="form-grid">
            <div class="form-group">
              <label for="goalDetails">Age</label>
              <input type="text" id="age" [(ngModel)]="profileForm.age" name="age" placeholder="Votre âge">
            </div>

            <div class="form-group">
              <label for="level">Genre</label>
              <select id="gender" [(ngModel)]="profileForm.gender" name="gender">
                <option [ngValue]="undefined">-- Sélectionner --</option>
                @for (gender of genders; track gender.value) {
                  <option [value]="gender.value">{{ gender.label }}</option>
                }
              </select>
            </div>

            <div class="form-group">
              <label for="level">Niveau</label>
              <select id="level" [(ngModel)]="profileForm.runningLevel" name="runningLevel">
                <option [ngValue]="undefined">-- Sélectionner --</option>
                @for (level of runningLevels; track level.value) {
                  <option [value]="level.value">{{ level.label }}</option>
                }
              </select>
            </div>

            <div class="form-group">
              <label for="goal">Objectif</label>
              <select id="goal" [(ngModel)]="profileForm.goal" name="goal">
                <option [ngValue]="undefined">-- Sélectionner --</option>
                @for (goal of goals; track goal.value) {
                  <option [value]="goal.value">{{ goal.label }}</option>
                }
              </select>
            </div>

            <div class="form-group">
              <label for="frequency">Fréquence (séances/semaine)</label>
              <input type="number" id="frequency" [(ngModel)]="profileForm.weeklyFrequency" name="weeklyFrequency" min="1" max="14" placeholder="3">
            </div>

            <div class="form-group">
              <label for="goalDetails">Détails objectif</label>
              <input type="text" id="goalDetails" [(ngModel)]="profileForm.goalDetails" name="goalDetails" placeholder="Ex: Marathon de Paris en avril">
            </div>

            <div class="form-group full-width">
              <label for="injuries">Blessures / Points de vigilance</label>
              <textarea id="injuries" [(ngModel)]="profileForm.injuries" name="injuries" rows="2" placeholder="Ex: Tendinite au genou droit, éviter les descentes"></textarea>
            </div>

            <div class="form-group full-width">
              <label>Jours disponibles pour courir</label>
              <div class="days-selector">
                @for (day of allDays; track day.value) {
                  <button
                    type="button"
                    class="day-btn"
                    [class.selected]="isDaySelected(day.value)"
                    (click)="toggleDay(day.value)">
                    {{ day.label }}
                  </button>
                }
              </div>
            </div>

            <div class="form-group">
              <label for="preferredTime">Créneau préféré</label>
              <select id="preferredTime" [(ngModel)]="profileForm.preferredTime" name="preferredTime">
                <option [ngValue]="undefined">-- Sélectionner --</option>
                @for (time of preferredTimes; track time.value) {
                  <option [value]="time.value">{{ time.label }}</option>
                }
              </select>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-secondary" (click)="toggleEdit()">Annuler</button>
            <button type="submit" class="btn-primary" [disabled]="isSaving()">
              @if (isSaving()) {
                Enregistrement...
              } @else {
                Enregistrer
              }
            </button>
          </div>
        </form>
      }
    </section>

    <!-- Intégration Strava -->
    <section class="strava-section">
      <div class="section-header">
        <h3>
          <svg class="strava-icon" viewBox="0 0 24 24" width="24" height="24">
            <path fill="#FC4C02" d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/>
          </svg>
          Strava
        </h3>
      </div>

      @if (stravaMessage()) {
        <div class="strava-message" [class.success]="stravaMessage()?.includes('succès') || stravaMessage()?.includes('importée')">
          {{ stravaMessage() }}
        </div>
      }

      @if (stravaLoading()) {
        <div class="strava-loading">Chargement...</div>
      } @else if (stravaStatus()?.connected) {
        <div class="strava-connected">
          <div class="strava-status">
            <span class="status-dot connected"></span>
            <span>Connecté depuis le {{ stravaStatus()?.connectedAt | date:'dd/MM/yyyy' }}</span>
          </div>
          <div class="strava-actions">
            <button class="btn-strava-sync" (click)="syncStrava()" [disabled]="stravaSyncing()">
              @if (stravaSyncing()) {
                Synchronisation...
              } @else {
                Importer mes courses
              }
            </button>
            <button class="btn-strava-resync" (click)="resyncStrava()" [disabled]="stravaSyncing()">
              Mettre à jour
            </button>
            <button class="btn-strava-disconnect" (click)="disconnectStrava()">
              Déconnecter
            </button>
          </div>
        </div>
      } @else {
        <div class="strava-disconnected">
          <p>Connecte ton compte Strava pour importer automatiquement tes courses.</p>
          <button class="btn-strava-connect" (click)="connectStrava()">
            <svg class="strava-icon-small" viewBox="0 0 24 24" width="18" height="18">
              <path fill="white" d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/>
            </svg>
            Connecter Strava
          </button>
        </div>
      }
    </section>

    <!-- Section Coach -->
    <section class="coach-section">
      <div class="section-header">
        <h3>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          Mon Coach
        </h3>
      </div>

      @if (coachMessage()) {
        <div class="coach-message" [class.success]="coachMessageType() === 'success'" [class.error]="coachMessageType() === 'error'">
          {{ coachMessage() }}
        </div>
      }

      @if (coachLoading()) {
        <div class="coach-loading">Chargement...</div>
      } @else {
        <!-- Coach actuel -->
        @if (currentCoach()) {
          <div class="current-coach">
            <div class="coach-avatar">
              @if (currentCoach()!.profilePicture) {
                <img [src]="currentCoach()!.profilePicture" alt="Coach">
              } @else {
                {{ currentCoach()!.firstName?.charAt(0) }}{{ currentCoach()!.lastName?.charAt(0) }}
              }
            </div>
            <div class="coach-info">
              <span class="coach-name">{{ currentCoach()!.firstName }} {{ currentCoach()!.lastName }}</span>
              <span class="coach-email">{{ currentCoach()!.email }}</span>
            </div>
            <button class="btn-leave-coach" (click)="leaveCoach()">Quitter</button>
          </div>
        } @else {
          <!-- Pas de coach -->
          <div class="no-coach">
            <p>Tu n'as pas encore de coach. Rejoins un coach pour bénéficier d'un accompagnement personnalisé !</p>

            <!-- Invitations en attente -->
            @if (pendingInvitations().length > 0) {
              <div class="pending-invitations">
                <h4>Invitations en attente</h4>
                @for (invitation of pendingInvitations(); track invitation._id) {
                  <div class="invitation-card">
                    <div class="invitation-info">
                      <span class="invitation-coach">{{ invitation.coach.firstName }} {{ invitation.coach.lastName }}</span>
                      <span class="invitation-date">Reçue le {{ invitation.invitedAt | date:'dd/MM/yyyy' }}</span>
                    </div>
                    <div class="invitation-actions">
                      <button class="btn-accept" (click)="acceptInvitation(invitation._id)">Accepter</button>
                      <button class="btn-reject" (click)="rejectInvitation(invitation._id)">Refuser</button>
                    </div>
                  </div>
                }
              </div>
            }

            <!-- Rejoindre par code -->
            <div class="join-by-code">
              <h4>Rejoindre un coach</h4>
              <p>Entre le code d'invitation fourni par ton coach :</p>
              <div class="code-input-group">
                <input
                  type="text"
                  [(ngModel)]="inviteCode"
                  placeholder="Code d'invitation"
                  [disabled]="joiningByCode()"
                >
                <button class="btn-join" (click)="joinByCode()" [disabled]="joiningByCode() || !inviteCode.trim()">
                  @if (joiningByCode()) {
                    Envoi...
                  } @else {
                    Rejoindre
                  }
                </button>
              </div>
            </div>
          </div>
        }
      }
    </section>

    <!-- Statistiques globales -->
    <section class="stats-grid">
      <div class="stat-card">
        <span class="stat-value">{{ getTotalRuns() }}</span>
        <span class="stat-label">Courses</span>
      </div>
      <div class="stat-card">
        <span class="stat-value">{{ getTotalDistance() | number:'1.1-1' }} km</span>
        <span class="stat-label">Distance totale</span>
      </div>
      <div class="stat-card">
        <span class="stat-value">{{ formatDuration(getTotalDuration()) }}</span>
        <span class="stat-label">Temps total</span>
      </div>
    </section>

    <!-- Historique des runs -->
    <section class="runs-section">
      <h3>Historique des courses</h3>

      @if (isLoading()) {
        <div class="loading">Chargement...</div>
      }

      @if (error()) {
        <div class="error-box">{{ error() }}</div>
      }

      @if (!isLoading() && runs().length === 0) {
        <div class="empty-state">
          <p>Aucune course enregistrée pour le moment.</p>
          <a routerLink="/" class="btn-primary">Enregistrer ma première course</a>
        </div>
      }

      @if (!isLoading() && runs().length > 0) {
        <div class="runs-list">
          @for (run of runs(); track run._id) {
            <div class="run-card clickable" (click)="openRunDetail(run)">
              <div class="run-header">
                <span class="run-date">{{ formatDate(run.date) }}</span>
                <div class="run-badges">
                  @if (run.stravaActivityId) {
                    <span class="strava-badge">Strava</span>
                  }
                  @if (run.sessionType) {
                    <span class="run-type">{{ run.sessionType }}</span>
                  }
                </div>
              </div>
              <div class="run-summary">
                {{ getRunSummary(run) }}
                @if (run.feeling) {
                  <span class="run-feeling">{{ getFeelingEmoji(run.feeling) }} {{ run.feeling }}/10</span>
                }
              </div>
              @if (run.notes) {
                <p class="run-notes">{{ run.notes }}</p>
              }
              @if (run.analysis) {
                <div class="run-analysis">
                  <span class="analysis-label">Analyse IA</span>
                  <p class="analysis-preview">{{ run.analysis }}</p>
                </div>
              }
              <span class="view-detail">{{ run.analysis ? 'Voir plus' : 'Voir les détails' }} &rarr;</span>
            </div>
          }
        </div>
      }
    </section>
  </main>
</div>
