<app-navbar></app-navbar>

<div class="container">
  <header class="page-header">
    <div class="header-content">
      <a routerLink="/planning" class="back-link">‚Üê Retour au planning</a>
      <h1>Logger une s√©ance muscu</h1>
    </div>
  </header>

  @if (error()) {
    <div class="alert error">{{ error() }}</div>
  }
  @if (successMessage()) {
    <div class="alert success">{{ successMessage() }}</div>
  }

  <div class="log-form">
    <!-- Session info -->
    <section class="form-section">
      <h2>Informations</h2>
      <div class="form-row">
        <div class="form-group">
          <label>Date</label>
          <input
            type="date"
            [ngModel]="sessionDate()"
            (ngModelChange)="sessionDate.set($event)"
          >
        </div>
        <div class="form-group">
          <label>Type de s√©ance</label>
          <select [ngModel]="sessionType()" (ngModelChange)="sessionType.set($event)">
            @for (type of sessionTypes; track type) {
              <option [value]="type">{{ getSessionTypeLabel(type) }}</option>
            }
          </select>
        </div>
        <div class="form-group">
          <label>Dur√©e (min)</label>
          <input
            type="number"
            placeholder="60"
            [ngModel]="sessionDuration()"
            (ngModelChange)="sessionDuration.set($event)"
            min="1"
          >
        </div>
      </div>
    </section>

    <!-- Exercises -->
    <section class="form-section">
      <div class="section-header">
        <h2>Exercices</h2>
        <button class="btn-primary" (click)="openExercisePicker()">
          + Ajouter un exercice
        </button>
      </div>

      @if (exercises().length === 0) {
        <div class="empty-exercises">
          <p>Aucun exercice ajout√©</p>
          <button class="btn-secondary" (click)="openExercisePicker()">
            Choisir un exercice
          </button>
        </div>
      } @else {
        <div class="exercises-list">
          @for (entry of exercises(); track $index; let i = $index) {
            <div class="exercise-card">
              <div class="exercise-header">
                <div class="exercise-info">
                  @if (getExercise(entry).imageUrl) {
                    <img [src]="getExercise(entry).imageUrl" [alt]="getExercise(entry).name" class="exercise-thumb">
                  } @else {
                    <div class="exercise-thumb placeholder">üí™</div>
                  }
                  <div>
                    <h3>{{ getExercise(entry).name }}</h3>
                    <span class="muscle-tag">{{ getMuscleLabel(getExercise(entry).primaryMuscle) }}</span>
                  </div>
                </div>
                <button class="btn-icon danger" (click)="removeExercise(i)" title="Supprimer">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>

              <div class="sets-table">
                <div class="sets-header">
                  <span class="col-set">S√©rie</span>
                  <span class="col-reps">Reps</span>
                  <span class="col-weight">Poids (kg)</span>
                  <span class="col-action"></span>
                </div>
                @for (set of entry.sets; track $index; let j = $index) {
                  <div class="set-row">
                    <span class="col-set">{{ j + 1 }}</span>
                    <input
                      type="number"
                      class="col-reps"
                      [ngModel]="set.reps"
                      (ngModelChange)="updateSet(i, j, 'reps', $event)"
                      min="1"
                    >
                    <input
                      type="number"
                      class="col-weight"
                      [ngModel]="set.weight"
                      (ngModelChange)="updateSet(i, j, 'weight', $event)"
                      min="0"
                      step="0.5"
                    >
                    <button
                      class="btn-icon small col-action"
                      (click)="removeSet(i, j)"
                      [disabled]="entry.sets.length <= 1"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                      </svg>
                    </button>
                  </div>
                }
              </div>
              <button class="btn-add-set" (click)="addSet(i)">
                + Ajouter une s√©rie
              </button>
            </div>
          }
        </div>
      }
    </section>

    <!-- Feeling -->
    <section class="form-section">
      <h2>Ressenti</h2>
      <div class="feeling-slider">
        <span class="feeling-label">üò´</span>
        <input
          type="range"
          min="1"
          max="10"
          [ngModel]="sessionFeeling()"
          (ngModelChange)="sessionFeeling.set($event)"
        >
        <span class="feeling-label">üí™</span>
        <span class="feeling-value">{{ sessionFeeling() }}/10</span>
      </div>
    </section>

    <!-- Notes -->
    <section class="form-section">
      <h2>Notes (optionnel)</h2>
      <textarea
        rows="3"
        placeholder="Comment s'est pass√©e la s√©ance ?"
        [ngModel]="sessionNotes()"
        (ngModelChange)="sessionNotes.set($event)"
      ></textarea>
    </section>

    <!-- Summary -->
    @if (exercises().length > 0) {
      <section class="summary-section">
        <div class="summary-item">
          <span class="summary-value">{{ exercises().length }}</span>
          <span class="summary-label">exercices</span>
        </div>
        <div class="summary-item">
          <span class="summary-value">{{ calculateTotalSets() }}</span>
          <span class="summary-label">s√©ries</span>
        </div>
        <div class="summary-item">
          <span class="summary-value">{{ calculateTotalVolume() | number:'1.0-0' }}</span>
          <span class="summary-label">kg total</span>
        </div>
      </section>
    }

    <!-- Submit -->
    <div class="form-actions">
      <button class="btn-secondary" routerLink="/planning">Annuler</button>
      <button
        class="btn-primary large"
        (click)="saveSession()"
        [disabled]="isSaving() || exercises().length === 0"
      >
        {{ isSaving() ? 'Enregistrement...' : 'Enregistrer la s√©ance' }}
      </button>
    </div>
  </div>
</div>

<!-- Exercise Picker Modal -->
@if (showExercisePicker()) {
  <div class="modal-overlay" (click)="closeExercisePicker()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Choisir un exercice</h2>
        <button class="close-btn" (click)="closeExercisePicker()">&times;</button>
      </div>
      <div class="modal-filters">
        <input
          type="text"
          placeholder="Rechercher..."
          [ngModel]="exerciseSearch()"
          (ngModelChange)="exerciseSearch.set($event)"
        >
        <select [ngModel]="exerciseFilterMuscle()" (ngModelChange)="exerciseFilterMuscle.set($event)">
          <option value="">Tous les muscles</option>
          @for (muscle of muscleGroups; track muscle) {
            <option [value]="muscle">{{ getMuscleLabel(muscle) }}</option>
          }
        </select>
      </div>
      <div class="modal-body">
        @if (isLoadingExercises()) {
          <div class="loading-state">
            <div class="loading-spinner"></div>
            <p>Chargement des exercices...</p>
          </div>
        } @else if (filteredExercises().length === 0) {
          <div class="empty-state">
            <p>Aucun exercice trouv√©</p>
          </div>
        } @else {
          <div class="exercise-picker-list">
            @for (exercise of filteredExercises(); track exercise._id) {
              <button class="exercise-picker-item" (click)="addExercise(exercise)">
                @if (exercise.imageUrl) {
                  <img [src]="exercise.imageUrl" [alt]="exercise.name" class="picker-thumb">
                } @else {
                  <div class="picker-thumb placeholder">üí™</div>
                }
                <div class="picker-info">
                  <span class="picker-name">{{ exercise.name }}</span>
                  <span class="picker-muscle">{{ getMuscleLabel(exercise.primaryMuscle) }}</span>
                </div>
                <span class="picker-add">+</span>
              </button>
            }
          </div>
        }
      </div>
    </div>
  </div>
}
